name: Build .dat files

on:
  push:
    branches:
      - master
    paths:
      - "geoip_config.json"
  repository_dispatch:
    types: [trigger-dat-build]
  workflow_dispatch:
    inputs:
      message:
        required: true
        type: string

permissions:
  contents: write

env:
  COMMIT_MSG: ${{ github.event.head_commit.message || inputs.message }}
  LISTS_REPO: https://raw.githubusercontent.com/itdoginfo/allow-domains/refs/heads/main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v6
        with:
          path: publish

      - name: Checkout geosite
        uses: actions/checkout@v6
        with:
          repository: v2fly/domain-list-community
          sparse-checkout: |
            main.go
            go.mod
            go.sum
            internal
          path: geosite

      - name: Checkout geoip
        uses: actions/checkout@v6
        with:
          repository: v2fly/geoip
          path: geoip

      - name: Setup Go for geosite
        uses: actions/setup-go@v6
        with:
          go-version-file: geosite/go.mod

      - name: Download domains
        run: |
          mkdir -p geosite/input && cd geosite/input
          mkdir {allow-domains,allow-categories,allow-countries,allow-services}
          curl -L "${LISTS_REPO}/Russia/inside-raw.lst" -o russia-inside/list --create-dirs
          curl -L "${LISTS_REPO}/Russia/outside-raw.lst" -o russia-outside/list --create-dirs
          curl -L "${LISTS_REPO}/Ukraine/inside-raw.lst" -o ukraine-inside/list --create-dirs
          for country in russia-inside russia-outside ukraine-inside; do
            cp "${country}/list" "allow-countries/${country}"
            cp "${country}/list" "allow-domains/${country}"
          done
          for category in anime block geoblock hodca news porn; do
            dest="${category}-domains/list"
            curl -L "${LISTS_REPO}/Categories/${category}.lst" -o "$dest" --create-dirs
            cp "$dest" "allow-categories/${category}"
            cp "$dest" "allow-domains/${category}"
          done
          for service in cloudflare cloudfront digitalocean discord google_ai google_play hdrezka hetzner meta ovh roblox telegram tiktok twitter youtube; do
            dest="${service//_/-}-domains/list"
            curl -L "${LISTS_REPO}/Services/${service}.lst" -o "$dest" --create-dirs
            cp "$dest" "allow-services/${service//_/-}"
            cp "$dest" "allow-domains/${service//_/-}"
          done

      - name: Build domains .dat files
        run: |
          cd geosite
          for category in ./input/*/; do
            go run ./ --datapath="${category}" --outputname="$(basename $category).dat" --outputdir="../publish/"
          done

      - name: Setup Go for geoip
        uses: actions/setup-go@v6
        with:
          go-version-file: geoip/go.mod

      - name: Download subnets
        run: |
          mkdir -p geoip/input && cd geoip/input
          for domain in cloudflare cloudfront digitalocean discord hetzner meta ovh telegram twitter; do
            curl -L "${LISTS_REPO}/Subnets/IPv4/${domain}.lst" -o "${domain}"
            curl -L "${LISTS_REPO}/Subnets/IPv6/${domain}.lst" >> "${domain}"
          done
          curl -L "${LISTS_REPO}/Subnets/IPv4/roblox.lst" -o "roblox"

      - name: Build subnets .dat files
        run: |
          cd geoip
          mkdir -p output
          go run ./ -c ../publish/geoip_config.json
          for filename in ./output/*.dat; do
            mv "${filename}" "../publish/$(basename $filename .dat)-subnets.dat"
          done

      - name: Release and upload assets
        run: |
          cd publish
          gh release create ${{ env.TAG_NAME }} -t ${{ env.RELEASE_NAME }} ./*.dat
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_NAME: $(date +'%Y-%m-%d_%H-%M-%S')
          TAG_NAME: $(date +'%Y-%m-%d_%H-%M-%S')

      - name: Trigger Happ routing rebuild
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.HAPP_ROUTING_TOKEN }}
          repository: KazZzeL/allow-domains-happ-routing
          event-type: trigger-routing-build
          client-payload: '{"commit_message": "${{ env.COMMIT_MSG }}"}'
